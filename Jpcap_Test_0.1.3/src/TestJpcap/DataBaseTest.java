package TestJpcap;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;
import java.net.InetAddress;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Scanner;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import jpcap.JpcapCaptor;
import jpcap.NetworkInterface;
import jpcap.NetworkInterfaceAddress;
import jpcap.packet.IPPacket;
import jpcap.packet.Packet;
import jpcap.packet.TCPPacket;
import jpcap.packet.UDPPacket;

import java.sql.Connection;  
import java.sql.DriverManager;  
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;  
  
public class DataBaseTest {
	Statement stmt ; 
	Connection conn;
	public DataBaseTest() {
	}
	public void LinkDB(){
		try {  
            Class.forName("com.mysql.cj.jdbc.Driver").newInstance();  
  
            String databaseName = "test";// 已经在MySQL数据库中创建好的数据库。  
            String userName = "root";// MySQL默认的root账户名  
            String password = "root";// 默认的root账户密码为空  
            conn = DriverManager.getConnection("jdbc:mysql://localhost:3306/" + databaseName+"?useSSL=false&serverTimezone=UTC", userName, password);          
            stmt = conn.createStatement();
            if(conn!=null)
             System.out.println("连接数据库成功！");
            else
             System.out.println("连接数据库失败！");
		 } catch (Exception e) {  
	            e.printStackTrace();  
	     }  
	}
	public void InsertData(Packet packet){
		Packet temppacket=packet;
		IPPacket Ipacket =(IPPacket)temppacket;
	    long[] time=new long[2];
	    InetAddress[] ip=new InetAddress[2];
	    short protocol;
	    int length;
	    int ident;
	    int srcPort;
		int dscPort;
	    String appProto;
	    String appInform[];
	    time[0]=Ipacket.sec;
	    time[1]=Ipacket.usec;
	    
	    ip[0]=Ipacket.src_ip;
        ip[1]=Ipacket.dst_ip;
        protocol=Ipacket.protocol;
	    length=Ipacket.len;
	    ident=Ipacket.ident;
	    
	    srcPort=-1;
		dscPort=-1;
		
	    if(protocol==6){
	      TCPPacket tpacket=(TCPPacket)Ipacket;
	      srcPort=tpacket.src_port;
	      dscPort=tpacket.dst_port;
	    }
	    else if(protocol==17){
	      UDPPacket tpacket=(UDPPacket)Ipacket;
	      srcPort=tpacket.src_port;
	      dscPort=tpacket.dst_port;
	    }
	    appProto=GetAppProtocol(temppacket,srcPort,dscPort);
	    appInform=new String[4];
	    for(int i=0;i<4;i++)
	     appInform[i]=null;
	    
	    if(appProto.equals("DNS")){
	      appInform=GetDNSInformation(appProto,packet);
	    }
	    
	    String sql;   
	    try {  
            int result;
                sql = "INSERT INTO data(time,mstime,srcIp,dscIp,protocol,length,srcPort,dscPort,appProto,appInform,appInform2,appInform3,appInform4) VALUES("+time[0]+","+time[1]+",'"+ip[0]+"','"+ip[1]+"',"+protocol+","+length+","+srcPort+","+dscPort+",'"+appProto+"','"+appInform[0]+"','"+appInform[1]+"','"+appInform[2]+"','"+appInform[3]+"')";  
                //System.out.println(sql);
                result = stmt.executeUpdate(sql);        
        } catch (Exception e) {  
            e.printStackTrace();  
        }
	}

	public String GetAppProtocol(Packet packet,int srcPort,int dscPort){
		String appProtocol="null";
		if (packet instanceof TCPPacket){
            TCPPacket tcppacket=(TCPPacket)packet;
            //System.out.println("数据部分");
            String endflag="    ";
            for(int i=0;i<tcppacket.data.length;i++){
      	     //System.out.print((char)tcppacket.data[i]);
      	     endflag=endflag+(char)tcppacket.data[i];
      	     endflag=endflag.substring(endflag.length()-4, endflag.length());
      	     if(endflag.equals("\r\n\r\n")&&((srcPort==80)||dscPort==80)){
      	    	appProtocol="HTTP";
      	       	break;
      	     }
            }
        }
        else if(packet instanceof UDPPacket)
        {
         if((srcPort==53)||(dscPort==53)){
           appProtocol="DNS";
         }
        }
		return appProtocol;
	}
	
	public String[] GetDNSInformation(String protocol,Packet packet){
	  String[]DnsInform=new String[4];
	  UDPPacket udppacket=(UDPPacket)packet;
      String Hex=null;
      StringBuffer str=new StringBuffer();
      StringBuffer str2=new StringBuffer();
      byte b;
      int data;
  	  int j=0;
  	  int answerflag=0;
  	  int answerrecord=0;
  	  int answerstart=0;
  	  int answerIp[]=new int[4];
  	  int endflag[]=new int[2];
  	  int dns_endflag=0;
      for(int i=0;i<2;i++){
        b=udppacket.data[i];
        data=Byte.toUnsignedInt(b);//有符号数转换为无符号数
        Hex=Integer.toHexString(data);
        str.append(Hex);
      }
      DnsInform[0]=str.toString();
      str.setLength(0);  
      for(int i=2;i<4;i++){
        b=udppacket.data[i];
        data=Byte.toUnsignedInt(b);
        Hex=Integer.toHexString(data);
        if(Hex.equals("81"))
       	 answerflag=1;
        str.append(Hex);  
      }
      DnsInform[1]=str.toString();
      str.setLength(0);     
      for(int i=12;i<udppacket.data.length;i++){
    	b=udppacket.data[i];
        data=Byte.toUnsignedInt(b);
        if(answerflag==1){            
            endflag[0]=endflag[1];
            endflag[1]=data;
         	if(endflag[0]==192&&endflag[1]==12){//DNS回答地址前会有c0 0c标识码（后跟回答的dns域名）  
              answerrecord=11;
              answerflag=0;
         	}
          }
          if(answerstart==1){
          	answerIp[j]=data;
          	j++;
          	if(j==4){
          	  answerstart=-1;
          	}
          }
          if(answerrecord!=0){
        	answerrecord--;
        	if(answerrecord==0){
        	  answerstart=1;
        	}
          }
        
        if(((data==5)||(data==4)||(data==3)||(data>47&&data<58)||(data>64&&data<123))&&(dns_endflag!=2)){
          if((data==5)||(data==4)||(data==3))
            str.append(".");
          else
        	str.append((char)udppacket.data[i]);
          dns_endflag=1;
        }
        else if(dns_endflag==1){
          dns_endflag=2;
        }
        if(answerstart==-1){
        	str2.append("/");
        	for(j=0;j<4;j++){
        	  str2.append(answerIp[j]);
        	  if(j<3)
        	    str2.append(".");
        	}
          answerstart=0;
          DnsInform[3]=str2.toString();
        }
      }
      DnsInform[2]=str.toString();
	  return DnsInform;
	}
	
	public void CloseConn(){
		try {
			conn.close();
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		};
	}
}
